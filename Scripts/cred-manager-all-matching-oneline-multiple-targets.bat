$UsersToDelete=@('^theusername$','^adomain\\theusername$'); $CredentialsList=cmdkey.exe /list; $TargetsToDelete=@(); $CredentialBlock=""; foreach($Line in $CredentialsList){ $CredentialBlock+=$Line+"`n"; if([string]::IsNullOrWhiteSpace($Line)){ if($CredentialBlock -match "User:\s*(.+)"){ $User=$matches[1].Trim(); foreach($UserPattern in $UsersToDelete){ if($User -match $UserPattern){ if($CredentialBlock -match "Target:\s*(\S+)"){ $TargetsToDelete+=$matches[1]; Write-Host "Found Target for deletion: $matches[1]" -ForegroundColor Green }}}}; $CredentialBlock="" }}; foreach($Target in $TargetsToDelete){ cmdkey.exe /delete $Target | Out-Null; Write-Host "Deleted credential for Target: $Target" -ForegroundColor Green }; if($TargetsToDelete.Count -eq 0){ Write-Host "No matching credentials found for specified users." -ForegroundColor Red }else{ Write-Host "All matching credentials deleted." -ForegroundColor Green }
